# PCIE协议 
## PCIE的传输速度
| 链接速度 | x1 | x2 | x4 | x8 | x12 | x16 | x32 |
|-------|:-:|:-:|:-:|:-:|:-:|:-:|:-:| 
|Gen1带宽（GB/s）|0.5|1|2|4|6|8|16| 
|Gen2带宽（GB/s）|1|2|4|8|12|16|32| 
|Gen3带宽（GB/s）|2|4|8|16|24|32|64| 

- x1、x2、x4为通道数（Lane），其中带宽为读写带宽，如果单指读或者写的带宽，应该减半。
- PCIE1.0的线上传输速率为2.5Gbps，物理层使用8/10编码，即8bit的数据，实际在物理线路上需要传输10bit，多余的2bit用于校验，所以其带宽为2.5*2/10=0.5GB/s
- PCIE2.0的线上传输速率为5Gbps，物理层使用8/10编码，所以其带宽为1GB/s
- PCIE3.0的线上传输速率为8Gbps，物理层使用的是128/130编码进行数据传输，所以带宽为：(8*2*128/130 )/8 ≈2GB/s
## PCIE的发展历史
`PCIE从PCI发展过来`，PCI使用并口传输，PCIE使用串口传输，在时钟频率比较低的时候，并口因为可以一次性传输若干个比特，速率确实比串口快。随着频率的提高，并口传输就没了优势。因为为了保证在接收端能够正确的接收数据，时钟周期必须大于数据传输的时间，受限于传输时间，所以时钟频率不能太高，同时时钟信号在线上传输的时候会有相位偏移，也会影响接收端的数据采集。由于采用并行传输，接收端必须等到最慢的那个bit数据到了以后才能锁住数据。总结就是并口由于是多根线一起传输，受时钟偏移的影响容易采错数据，也因为要等最慢的那个bit数据到达，所以时钟频率也上不去。
## PCIE的拓扑结构
PCIE的拓扑结构为一个树形结构，如图所示。Root Complex(RC)是树的根，负责转发CPU的通信，其内部实现结构比较复杂，一般来说里面有一条内部PCIE总线（BUS 0）,通过若干个PCIE bridge扩展出一些PCIE port。

PCIE Endpoint 就是PCIE终端设备，比如PCIE SSD，网卡等，这些Endpoint可以直连在RC上也可以通过switch连接在PCIE总线上。Switch内部结构和RC类似，里面也有一条内部PCIE总线，也由几个bridge扩展出接口。每个switch只能有一个上游，但可以有多个下游，下游也可以是switch。所以就可以形成一个树形结构，PCIE采用点到点通信，但一般两个设备协议不一样，所以一般先和RC通信，再和Endpoint通信。
## PCIE的分层结构
PCIe定义了下三层：**事务层（Transaction Layer）** 、 **数据链路层 （Data Link Layer）** 和 **物理层（Physical Layer，包括逻辑子模块和电气 子模块）**，每层职能是不同的，但下层总是为上层服务的。分层设计的 一个好处是，如果层次分得够好，接口版本升级时，硬件设计可能只需 要改动某一层，其他层可以保持不动。PCIe传输的数据从上到下，都是以数据包（Packet）的形式传输 的，每层数据包都是有其固定的格式。
- **事务层**的主要职责是创建（发送）或者解析（接收） TLP（Transaction Layer Packet）、流量控制、QoS、事务排序等。 
- **数据链路层**的主要职责是创建（发送）或者解析（接收） DLLP（Data Link Layer Packet）、Ack/Nak协议（链路层检错和纠错）、流控、电源管理等。 
- **物理层**的主要职责是处理所有的Packet数据物理传输，发送端数据 分发到各个Lane传输（Stripe），接收端把各个Lane上的数据汇总起来 （De-stripe），每个Lane上加扰（Scramble，目的是让0和1分布均匀， 去除信道的电磁干扰EMI）和去扰（De-scramble），以及8/10或者 128/130编码解码等。

**每个RC和switch都要实现这三层。Switch的主要功能是转发数据，为什么还需要实现事务层？Switch 必须实现这三层，因为数据的目的地信息是在TLP中的，如果不实现这 一层，就无法知道目的地址，也就无法实现数据寻址路由。**

### TLP的类型：
	根据软件层的不同请求，事务层产生四种不同的TLP请求：
 ·Memory； ·IO； ·Configuration； ·Message。
分别用于访问`内存空间`，`IO空间`，`配置空间`和`通过.Message传输中断、错误、电源等信息`。比较常用的是内存空间访问。其中读是必须要得到响应（Non-Posted）的，写不需要回复(Posted)。数据链路层提供了 ACK/NAK机制，一定程度上能保证TLP正确交互，因此能很大程度上 减小了数据写失败的可能。Config读写都要响应，PCIe里面所有的TLP=Request TLP+Completion TLP。 一个TLP最多只能携带4KB有效数据，因此，上例中，如果PCIe设 备C需要读16KB的数据，则RC必须返回4个CplD给PCIe设备C。注意， PCIe设备C只需发1个MRd就可以了。

TLP包括Header，Data, ECRC。Header里面包括了TLP的一些配置信息，比如是否有数据，是否开CRC校验，数据长度，优先级，来源，目标等 每个PCIE设备都有配置空间，路由时会去配置空间中对比地址。

### 数据链路层：
给TLP加上序列号（Sequence Number）用于保证数据的连续性和LCRC（Sequence Number）用于保证数据的正确性，然后交给物理层。接收时检查，没问题再传给事务层。拥有握手和重传协议保证数据一致性和完整性。
数据链路层主要有四大类型DLLP： ·用以确保TLP传输完整性的DLLP：ACK/NAK； ·流控相关的DLLP，保证通信效率，接收端会时不时发生DLLP告诉对方自己有多少TLP接收空间； ·电源管理相关的DLLP； ·厂家自定义DLLP。


### 物理层： 
串行总线，差分信号，物理层加头尾，作为边界符号，让数据与随机数据进行异或，输出伪随机数据，可以减少电磁干扰。加扰后进行编码。
物理层间传输 Ordered Sets 简称OS，用于管理链路，比如链路训练，改变链路电源状态等。
